<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <canvas id="main-canvas" width="1000" height="400" style="border: 1mm black solid;">Use newer browser
        instead.</canvas>
    <script>
        let status = "nothing";
        let movement_time = 0; // <= 1s
        let movement_start = 0;
        let run_time = 1000.0; //ms

        let left_bound = Number(window.prompt("Left bound?", "0"));
        let right_bound = Number(window.prompt("Left bound?", "4000"));
        
        function redraw(time) {
            let main_canvas = document.getElementById("main-canvas");
            let main_context = main_canvas.getContext("2d");
            main_context.fillStyle = "#00AAFF";
            main_context.clearRect(0, 0, main_canvas.clientWidth, main_canvas.clientHeight);

            if (movement_start == -1) {
                movement_start = time;
            }

            if (status == "right") {
                let x_pos = (time - movement_start) / run_time * main_canvas.clientWidth;
                main_context.fillRect(x_pos - 25, 0, 50, 50);
                if (x_pos > main_canvas.clientWidth) {
                    status = "nothing";
                    movement_start = time;
                }
            }

            if (status == "left") {
                let x_pos = (1 - (time - movement_start) / run_time) * main_canvas.clientWidth;
                main_context.fillRect(x_pos - 25, 0, 50, 50);
                if (x_pos < 0) {
                    status = "nothing";
                    movement_start = time;
                }
            }

            window.requestAnimationFrame(redraw);
        }

        window.requestAnimationFrame(redraw);

        let url = new URL(window.location.href);
        console.log((url.protocol == "http:" ? "ws:" : "wss:") + "//" + url.host + url.pathname + "ws");
        let socket = new WebSocket((url.protocol == "http:" ? "ws:" : "wss:") + "//" + url.host + url.pathname + "ws");

        socket.onopen = (event) => {
            socket.send("position\n"+ left_bound +" "+ right_bound);
            socket.onmessage = (msg) => {
                console.log(msg);
                let msg_split = msg.data.split("\n");
                let row_count = 1;
                console.log(msg_split);
                switch (msg_split[0]) {
                    case "right":
                        status = "right";
                        movement_start = -1;
                        break;
                    case "left":
                        status = "left";
                        movement_start = -1;
                        break;
                }
                run_time = msg_split[1] * 1000;
                console.log(run_time);
            };
        };
    </script>
</body>

</html>